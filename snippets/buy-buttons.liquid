{% comment %}
  Renders product buy-buttons.
  Accepts:
  - product: {Object} product object.
  - block: {Object} passing the block information.
  - product_form_id: {String} product form id.
  - section_id: {String} id of section to which this snippet belongs.
  - show_pickup_availability: {Boolean} for the pickup availability. If true the pickup availability is rendered, false - not rendered (optional).

  Usage:
  {% render 'buy-buttons', block: block, product: product, product_form_id: product_form_id, section_id: section.id, show_pickup_availability: true %}
{% endcomment %}
<style></style>
<div {{ block.shopify_attributes }}>
  {%- if product != blank -%}
    {%- liquid
      assign gift_card_recipient_feature_active = false
      if block.settings.show_gift_card_recipient and product.gift_card?
        assign gift_card_recipient_feature_active = true
      endif

      assign show_dynamic_checkout = false
      if block.settings.show_dynamic_checkout and gift_card_recipient_feature_active == false
        assign show_dynamic_checkout = true
      endif
    -%}

    <product-form
      class="product-form"
      data-hide-errors="{{ gift_card_recipient_feature_active }}"
      data-section-id="{{ section.id }}"
    >
      {%- form 'product',
        product,
        id: product_form_id,
        class: 'form ',
        novalidate: 'novalidate',
        data-type: 'add-to-cart-form'
      -%}
        <input
          type="hidden"
          name="id"
          value="{{ product.selected_or_first_available_variant.id }}"
          class="product-variant-id"
        >
        {% assign productType = product.type | handleize %}
        {% assign defaultValueOption1 = product.metafields.custom.default_value_of_the_product_for_the_option_1 %}
        {% assign defaultValueOption2 = product.metafields.custom.default_value_of_the_product_for_the_option_2 %}
        {% assign defaultValueOption3 = product.metafields.custom.color.value %}
        {% assign optionTitle1 = shop.metaobjects.define_products_variant_title[productType].variant_type_1_title.value %}
        {% assign optionTitle2 = shop.metaobjects.define_products_variant_title[productType].variant_type_2_title.value %}
        {% assign optionTitle3 = shop.metaobjects.define_products_variant_title[productType].variant_type_3_title.value %}

        {% if defaultValueOption1 and optionTitle1 %}
          <input
            class="option-chill1 hidden"
            style="visibility:hidden;"
            type="text"
            name="properties[{{ optionTitle1 }}]"
            value="{{ defaultValueOption1 }}"
          >
        {% endif %}

        {% if defaultValueOption2 and optionTitle2 %}
          <input
            class="option-chill1 hidden"
            style="visibility:hidden;"
            type="text"
            name="properties[{{ optionTitle2 }}]"
            value="{{ defaultValueOption2 }}"
          >
        {% endif %}
        {% if defaultValueOption3.color_name and optionTitle3 %}
          <input
            class="option-chill1 hidden"
            style="visibility:hidden;"
            type="text"
            name="properties[{{ optionTitle3 }}]"
            value="{{ defaultValueOption3.color_name }}"
          >
        {% endif %}

        {%- if gift_card_recipient_feature_active -%}
          {%- render 'gift-card-recipient-form', product: product, form: form, section: section -%}
        {%- endif -%}

      {%- if show_dynamic_checkout -%}
        <div class="product-form__buttons">
          {%- liquid
            assign check_against_inventory = true
            if product.selected_or_first_available_variant.inventory_management != 'shopify' or product.selected_or_first_available_variant.inventory_policy == 'continue'
              assign check_against_inventory = false
            endif
            if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
              assign quantity_rule_soldout = true
            endif
          -%}
            {{ form | payment_button }}
            <button
              {% if product.selected_or_first_available_variant.available == false or quantity_rule_soldout %}
                disabled
              {% endif %}
              onclick="checkoutFunctionality(event)"
              class="hidden shopify-payment-button__button--unbranded"
              id="custom_buy_button"
            >
              BUY NOW
            </button>  
        </div>
             {%- endif -%}

        <button
          id="ProductSubmitButton-{{ section_id }}"
          type="submit"
          name="add"
          class="pdp_ATC product-form__submit button button--full-width {% if show_dynamic_checkout %}button--secondary{% else %}button--primary{% endif %}"
          {% if product.selected_or_first_available_variant.available == false or quantity_rule_soldout %}
            disabled
          {% endif %}
        >
          <span>
            {%- if product.selected_or_first_available_variant.available == false or quantity_rule_soldout -%}
              {{ 'products.product.sold_out' | t }}
            {%- else -%}
              {{ 'products.product.add_to_cart' | t }}
            {%- endif -%}
          </span>
          <div class="loading-overlay__spinner hidden">
            <svg
              aria-hidden="true"
              focusable="false"
              class="spinner"
              viewBox="0 0 66 66"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
            </svg>
          </div>
        </button>
      {%- endform -%}
       <div class="product-form__error-message-wrapper" role="alert" hidden>
               <!-- <span class="product-form__error-message"></span> -->
              <span class="atc_Error_Messag1">Only {{ product.first_available_variant.inventory_quantity }} {{ product.title }} add to your cart.</span>      
      </div>
    </product-form>
  {%- else -%}
    <div class="product-form">
      <div class="product-form__buttons form">
        <button
          type="submit"
          name="add"
          class="pdp_ATC product-form__submit button button--full-width button--primary"
          disabled
        >
          {{ 'products.product.sold_out' | t }}
        </button>
      </div>
    </div>
  {%- endif -%}

  {%- if show_pickup_availability -%}
    {{ 'component-pickup-availability.css' | asset_url | stylesheet_tag }}

    {%- assign pick_up_availabilities = product.selected_or_first_available_variant.store_availabilities
      | where: 'pick_up_enabled', true
    -%}

    <pickup-availability
      class="product__pickup-availabilities no-js-hidden quick-add-hidden"
      {% if product.selected_or_first_available_variant.available and pick_up_availabilities.size > 0 %}
        available
      {% endif %}
      data-root-url="{{ routes.root_url }}"
      data-variant-id="{{ product.selected_or_first_available_variant.id }}"
      data-has-only-default-variant="{{ product.has_only_default_variant }}"
    >
      <template>
        <pickup-availability-preview class="pickup-availability-preview">
          {% render 'icon-unavailable' %}
          <div class="pickup-availability-info">
            <p class="caption-large">{{ 'products.product.pickup_availability.unavailable' | t }}</p>
            <button class="pickup-availability-button link link--text underlined-link">
              {{ 'products.product.pickup_availability.refresh' | t }}
            </button>
          </div>
        </pickup-availability-preview>
      </template>
    </pickup-availability>

    <script src="{{ 'pickup-availability.js' | asset_url }}" defer="defer"></script>
  {%- endif -%}
</div>
<script>
    async function checkoutFunctionality(event) {
   
      event.preventDefault();

      let size_input = document.querySelector('input[type="radio"][data-size="size"]:checked');
      if(size_input == null){
        document.querySelectorAll(".product-form__error-message-wrapper").forEach((e)=>{ e.removeAttribute("hidden") }); 
      }
      {% comment %} document.querySelectorAll('[data-testid=Checkout-button]')[1].removeAttribute('disabled'); {% endcomment %}
      {% comment %} document.querySelector('[data-testid=Checkout-button]').click(); {% endcomment %}

      let atc_value = document.querySelector('.product-variant-id')?.value;
      if(!atc_value){
      document.querySelector('.shopify-payment-button__button').setAttribute('disabled',true);
      console.log('disabled');
      }
      else{
        console.log('Abled');
        document.querySelector('.shopify-payment-button__button').setAttribute('disabled',false);
        const custom_checkout  = await clearShopifyCart(atc_value);
      }
   
    }



    async function clearShopifyCart(atc_value) {
      console.log("hello");
      try {
        const response = await fetch('/cart/clear.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
        });

        if (!response.ok) {
          throw new Error('Error clearing cart');
        }
        const data = await response.json();
        // Check if the cart was successfully cleared
        if (data.item_count === 0) {
          customBuyButtonFunctionality(atc_value)
          console.log("cartttt")
          // You can any additional actions you want to perform after clearing the cart here.
        } else {
          console.error('Error clearing cart:', data);
        }
      } catch (error) {
        console.error('Error clearing cart:', error);
      }
    }


    async function addToCartCustom(variantId) {

    // Create the request data
    const requestData = {
      items: [
        {
          id: variantId,
          quantity: 1,

        },
      ],

    };

    try {
      // Send a POST request to cart/add.js
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest' // Shopify expects this header for AJAX requests
        },
        body: JSON.stringify(requestData)
      });

      // Handle the response data
      const data = await response.json();
      // Return the response data if needed
      console.log("items add")
      return data;
    } catch (error) {
      console.error('Error adding product to cart:', error);
      throw error; // Rethrow the error if you want to handle it further
    }
  }

    function customBuyButtonFunctionality(variantId){
    addToCartCustom(variantId)
      .then(() => {
        location.href="/checkout"
      })
      .catch((error) => {
        console.error(error.message)
      });
    }
</script>
